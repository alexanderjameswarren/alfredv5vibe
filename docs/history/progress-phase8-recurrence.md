# Progress: Phase 8 — Intention Recurrence

## Status: Complete

### Development Steps
- [x] Step 1: SQL migrations (1a–1c) — run in Supabase SQL Editor
- [x] Step 2: Create `src/utils/recurrence.js` — pure `calculateNextEventDate` function
- [x] Step 3: Create `src/utils/recurrenceDisplay.js` — human-readable display string helper
- [x] Step 4: Update data layer — intent CRUD to read/write `recurrenceConfig`, add normalization helper
- [x] Step 5: Wire `calculateNextEventDate` into `closeExecution` and manual event archive via `triggerRecurrence` helper
- [x] Step 6: Build quick-select dropdown (replacing current 4-option select)
- [x] Step 7: Build custom recurrence dialog (fixed schedule)
- [x] Step 8: Build interval-from-completion dialog
- [x] Step 9: Add display string to intention cards and edit form
- [x] Step 10: Add end date + target start date fields to intention edit form
- [x] Step 11: End-to-end testing of all scenarios
- [x] Step 12: Drop old `recurrence` column (migration 1d)

### Notes
- Step 1 completed: recurrence_config, target_start_date, end_date columns added. Existing data migrated.
- Step 2 completed: `src/utils/recurrence.js` created with `calculateNextEventDate(config, referenceDate)` pure function. All cases implemented: fixed daily (3a), fixed weekly with multi-week anchor alignment (3b), fixed monthly by day-of-month with clamping (3c), fixed monthly by ordinal weekday including "weekday" and "last" (3d), and interval from completion (3e). Validation script at `src/utils/recurrence.test.js` — 13/13 tests passing (7 required scenarios + 6 edge cases). No external dependencies — native Date only.
- Step 3 completed: `src/utils/recurrenceDisplay.js` created with `getRecurrenceDisplayString(config, endDate)`. Covers all config shapes from spec Section 6d table, ordinal suffixes (1st/2nd/3rd/11th/21st etc.), end-date formatting ("· until May 29, 2026"). 21 display tests added — 34/34 total tests passing.
- Step 4 completed: `getRecurrenceConfig(intent)` normalization helper added to `recurrence.js`. All 3 intent creation pathways (triage, handleAddIntentionToContext, startNowFromItem) and `updateIntent` now write `recurrenceConfig`, `targetStartDate`, `endDate`. Recycling bin query updated to include new columns. Old `recurrence` field preserved for backward compat during transition. Build verified clean.
- Step 5 completed: `triggerRecurrence(intentId, archivedEvent)` helper added to Alfred.jsx. Uses `getRecurrenceConfig` + `calculateNextEventDate` to auto-create next event. Wired into both `closeExecution` (replaces old `recurrence === "once"` check with full config-based logic) and `updateEvent` (triggers on manual event archive). End-date enforcement included. Build verified clean.
- Step 6 completed: `RecurrenceQuickSelect` component built with dynamic labels based on today's date (e.g., "Weekly on Friday", "Monthly on the 27th"). Five quick options + "Custom…" and "After completion…" stub callbacks. Replaces both `<select>` elements (triage form + IntentionCard edit form). Both forms now produce `recurrenceConfig` objects alongside legacy `recurrence` strings. Custom dropdown with outside-click-to-close. Build verified clean.
- Steps 7+8 completed together: `CustomRecurrenceDialog` — full Google Calendar-style modal with frequency picker (day/week/month), interval, day-of-week circle toggles, monthly mode radio (day-of-month vs ordinal weekday with 5 ordinals + weekday option), anchor date for multi-week intervals, end-date picker. `IntervalRecurrenceDialog` — completion-based scheduling with every/unit/end-date. Both dialogs managed internally by `RecurrenceQuickSelect` (no parent wiring needed). End dates from dialogs flow through `onEndDateChange` callback to parent state. Build verified clean.
- Step 9 completed: Imported `getRecurrenceDisplayString` from `recurrenceDisplay.js` into Alfred.jsx. IntentionCard read mode now shows rich human-readable recurrence text (e.g., "Weekly on Tuesday", "Every 3 months on the first weekday · until May 29, 2026") instead of raw legacy string ("daily"/"weekly"/"once"). `RecurrenceQuickSelect.getDisplayLabel()` refactored to use `getRecurrenceDisplayString` for custom/interval configs, eliminating generic "Custom weekly"/"Custom monthly" fallbacks. Build verified clean.
- Step 10 completed: Added `targetStartDate` state + `<input type="date">` fields for both Target Start Date and End Date to IntentionCard edit form (side-by-side layout, shown when `showScheduling`). Same pair added to triage form after recurrence dropdown. `targetStartDate` wired into IntentionCard `handleSave` updates and `handleCancel` reset. Triage form save data now includes `targetStartDate`. Both reset paths (suggestion prefill + form reset) clear `intentEndDate` and `intentTargetStartDate`. Build verified clean.
- Step 11 completed: All 12 spec test scenarios reviewed against code. Added 18 new tests: 6 `getRecurrenceConfig` normalization tests (legacy daily/weekly/monthly/once, empty object, recurrenceConfig-takes-priority), opposite-week biweekly (Test 3), quarterly late-completion skip (Test 5b), end-date enforcement simulation with 6 assertions (Test 8), and multi-day weekly gym sequence Mon→Wed→Fri→Mon (Test 12). Total: **52/52 tests passing**. Code review confirmed: `triggerRecurrence` correctly uses today as reference for both fixed and interval types, `closeExecution` properly branches once vs recurring, `updateEvent` triggers recurrence on manual archive, `toSnakeCase`/`toCamelCase` round-trip preserves JSONB keys (daysOfWeek ↔ days_of_week), end-date comparison uses `T23:59:59` for inclusive end-date. Build verified clean.
- Step 12 completed: Column already dropped by user in Supabase. Frontend cleanup: removed all legacy `recurrence` TEXT field references from Alfred.jsx. Removed `recurrence` from `updateIntent`, all 3 intent creation pathways (triage, handleAddIntentionToContext, startNowFromItem), recycling bin query, IntentionCard state/save/cancel/dirty-check, triage form state/save/reset. Removed `legacy` parameter from `RecurrenceQuickSelect` options/select/onChange and `CustomRecurrenceDialog` onDone. Updated history subtitle and intention detail display to use `getRecurrenceDisplayString(getRecurrenceConfig(...))`. Removed `intentRecurrence`/`setIntentRecurrence` state from triage form. Build verified clean (bundle -177B).
